#!/bin/bash
# netopt-benchmark.sh - Compare performance before and after netopt

set -euo pipefail

# Configuration
PING_TARGET="google.com"
DOWNLOAD_URL="http://speedtest.tele2.net/100MB.zip"
INTERFACE="${1:-wlan0}"
NETOPT_SCRIPT="/etc/NetworkManager/dispatcher.d/99-netopt"

# Test URLs for page load time
declare -a TEST_URLS=(
    "https://www.amazon.com"
    "https://www.ebay.com"
    "https://www.wikipedia.org"
)

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Results storage
declare -A PHASE1_RESULTS
declare -A PHASE2_RESULTS

echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Network Optimizer - Performance Benchmark                ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    echo -e "${RED}Error: This script must be run as root (sudo/doas)${NC}"
    exit 1
fi

# Check if interface exists
if ! ip link show "$INTERFACE" &>/dev/null; then
    echo -e "${RED}Error: Interface $INTERFACE not found${NC}"
    exit 1
fi

# Check dependencies
for cmd in wget curl bc ping; do
    if ! command -v "$cmd" &>/dev/null; then
        echo -e "${RED}Error: $cmd is not installed${NC}"
        exit 1
    fi
done

# Function to measure ping latency
measure_ping() {
    local phase=$1
    echo -e "${YELLOW}→ Measuring ping latency (20 packets)...${NC}"
    
    local ping_output
    ping_output=$(ping -c 20 -i 0.5 -q "$PING_TARGET" 2>&1 | grep 'rtt min/avg/max/mdev' || echo "")
    
    if [ -z "$ping_output" ]; then
        echo -e "${RED}  Error: Ping failed${NC}"
        return 1
    fi
    
    local avg_rtt
    avg_rtt=$(echo "$ping_output" | awk -F'/' '{print $5}')
    
    if [ "$phase" == "1" ]; then
        PHASE1_RESULTS[ping_avg]=$avg_rtt
    else
        PHASE2_RESULTS[ping_avg]=$avg_rtt
    fi
    
    echo -e "  ${GREEN}Average RTT: ${avg_rtt}ms${NC}"
}

# Function to measure latency under load (download runs in background)
measure_latency_under_load() {
    local phase=$1
    echo -e "${YELLOW}→ Measuring latency under load...${NC}"
    
    # Start background download with timeout
    timeout 60 wget -q "$DOWNLOAD_URL" -O /dev/null &
    local wget_pid=$!
    
    # Give download 3 seconds to start
    sleep 3
    
    # Check if download is still running
    if ! kill -0 $wget_pid 2>/dev/null; then
        echo -e "${RED}  Error: Download failed to start${NC}"
        if [ "$phase" == "1" ]; then
            PHASE1_RESULTS[ping_under_load]="0"
        else
            PHASE2_RESULTS[ping_under_load]="0"
        fi
        return 1
    fi
    
    # Measure latency during download
    echo -e "  ${YELLOW}Measuring latency during active download...${NC}"
    local ping_under_load
    ping_under_load=$(ping -c 10 -i 0.5 -q "$PING_TARGET" 2>&1 | grep 'rtt min/avg/max/mdev' | awk -F'/' '{print $5}' || echo "0")
    
    # Kill download (we only needed it for latency test)
    kill $wget_pid 2>/dev/null || true
    wait $wget_pid 2>/dev/null || true
    
    if [ "$phase" == "1" ]; then
        PHASE1_RESULTS[ping_under_load]=$ping_under_load
    else
        PHASE2_RESULTS[ping_under_load]=$ping_under_load
    fi
    
    echo -e "  ${GREEN}Latency under load: ${ping_under_load}ms${NC}"
}

# Function to measure page load time
measure_page_load() {
    local url=$1
    local phase=$2
    
    # Use curl with timeout to measure time to first byte and total time
    local curl_output
    curl_output=$(timeout 30 curl -o /dev/null -s -w "%{time_starttransfer}:%{time_total}" "$url" 2>&1 || echo "0:0")
    
    local ttfb=$(echo "$curl_output" | cut -d':' -f1)
    local total_time=$(echo "$curl_output" | cut -d':' -f2)
    
    echo "$ttfb:$total_time"
}

# Function to measure all page loads
measure_all_pages() {
    local phase=$1
    echo -e "${YELLOW}→ Measuring page load times...${NC}"
    
    local total_ttfb=0
    local total_load=0
    local count=0
    
    for url in "${TEST_URLS[@]}"; do
        echo -e "  Testing: ${url}"
        local result
        result=$(measure_page_load "$url" "$phase")
        
        local ttfb=$(echo "$result" | cut -d':' -f1)
        local load_time=$(echo "$result" | cut -d':' -f2)
        
        # Skip if failed (0:0)
        if [ "$ttfb" == "0" ] || [ "$load_time" == "0" ]; then
            echo -e "    ${RED}Failed (timeout or error)${NC}"
            continue
        fi
        
        # Convert to milliseconds for better readability
        ttfb=$(echo "$ttfb * 1000" | bc)
        load_time=$(echo "$load_time * 1000" | bc)
        
        total_ttfb=$(echo "$total_ttfb + $ttfb" | bc)
        total_load=$(echo "$total_load + $load_time" | bc)
        count=$((count + 1))
        
        echo -e "    ${GREEN}TTFB: ${ttfb}ms, Total: ${load_time}ms${NC}"
        sleep 1  # Brief pause between requests
    done
    
    # Calculate averages (handle division by zero)
    if [ "$count" -gt 0 ]; then
        local avg_ttfb=$(echo "scale=2; $total_ttfb / $count" | bc)
        local avg_load=$(echo "scale=2; $total_load / $count" | bc)
    else
        local avg_ttfb="0"
        local avg_load="0"
        echo -e "  ${RED}All page load tests failed${NC}"
    fi
    
    if [ "$phase" == "1" ]; then
        PHASE1_RESULTS[page_ttfb]=$avg_ttfb
        PHASE1_RESULTS[page_load]=$avg_load
    else
        PHASE2_RESULTS[page_ttfb]=$avg_ttfb
        PHASE2_RESULTS[page_load]=$avg_load
    fi
    
    echo -e "  ${GREEN}Average TTFB: ${avg_ttfb}ms (${count}/3 successful)${NC}"
    echo -e "  ${GREEN}Average Load Time: ${avg_load}ms (${count}/3 successful)${NC}"
}

# Function to calculate percentage improvement
calc_improvement() {
    local before=$1
    local after=$2
    
    # Handle zero values
    if [ "$before" == "0" ] || [ "$after" == "0" ]; then
        echo "0"
        return
    fi
    
    # For latency/time metrics, lower is better
    local improvement=$(echo "scale=2; (($before - $after) / $before) * 100" | bc)
    echo "$improvement"
}

# Function to display comparison
display_comparison() {
    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  Performance Comparison Results                           ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Ping latency (idle)
    local ping_improvement=$(calc_improvement "${PHASE1_RESULTS[ping_avg]}" "${PHASE2_RESULTS[ping_avg]}")
    echo -e "${YELLOW}Ping Latency (Idle):${NC}"
    echo -e "  Before: ${PHASE1_RESULTS[ping_avg]}ms"
    echo -e "  After:  ${PHASE2_RESULTS[ping_avg]}ms"
    printf "  Improvement: "
    if (( $(echo "$ping_improvement > 0" | bc -l) )); then
        echo -e "${GREEN}${ping_improvement}%${NC} (better)"
    else
        echo -e "${RED}${ping_improvement}%${NC} (worse)"
    fi
    echo ""
    
    # Latency under load
    if [ "${PHASE1_RESULTS[ping_under_load]}" != "0" ] && [ "${PHASE2_RESULTS[ping_under_load]}" != "0" ]; then
        local load_improvement=$(calc_improvement "${PHASE1_RESULTS[ping_under_load]}" "${PHASE2_RESULTS[ping_under_load]}")
        echo -e "${YELLOW}Latency Under Load:${NC}"
        echo -e "  Before: ${PHASE1_RESULTS[ping_under_load]}ms"
        echo -e "  After:  ${PHASE2_RESULTS[ping_under_load]}ms"
        printf "  Improvement: "
        if (( $(echo "$load_improvement > 0" | bc -l) )); then
            echo -e "${GREEN}${load_improvement}%${NC} (better)"
        else
            echo -e "${RED}${load_improvement}%${NC} (worse)"
        fi
        echo ""
    else
        echo -e "${YELLOW}Latency Under Load:${NC} ${RED}Measurement failed${NC}"
        echo ""
    fi
    
    # Page TTFB
    if [ "${PHASE1_RESULTS[page_ttfb]}" != "0" ] && [ "${PHASE2_RESULTS[page_ttfb]}" != "0" ]; then
        local ttfb_improvement=$(calc_improvement "${PHASE1_RESULTS[page_ttfb]}" "${PHASE2_RESULTS[page_ttfb]}")
        echo -e "${YELLOW}Page Load - Time To First Byte:${NC}"
        echo -e "  Before: ${PHASE1_RESULTS[page_ttfb]}ms"
        echo -e "  After:  ${PHASE2_RESULTS[page_ttfb]}ms"
        printf "  Improvement: "
        if (( $(echo "$ttfb_improvement > 0" | bc -l) )); then
            echo -e "${GREEN}${ttfb_improvement}%${NC} (faster)"
        else
            echo -e "${RED}${ttfb_improvement}%${NC} (slower)"
        fi
        echo ""
    else
        echo -e "${YELLOW}Page TTFB:${NC} ${RED}Measurement failed${NC}"
        echo ""
    fi
    
    # Page total load
    if [ "${PHASE1_RESULTS[page_load]}" != "0" ] && [ "${PHASE2_RESULTS[page_load]}" != "0" ]; then
        local page_improvement=$(calc_improvement "${PHASE1_RESULTS[page_load]}" "${PHASE2_RESULTS[page_load]}")
        echo -e "${YELLOW}Page Load - Total Time:${NC}"
        echo -e "  Before: ${PHASE1_RESULTS[page_load]}ms"
        echo -e "  After:  ${PHASE2_RESULTS[page_load]}ms"
        printf "  Improvement: "
        if (( $(echo "$page_improvement > 0" | bc -l) )); then
            echo -e "${GREEN}${page_improvement}%${NC} (faster)"
        else
            echo -e "${RED}${page_improvement}%${NC} (slower)"
        fi
        echo ""
    else
        echo -e "${YELLOW}Page Load Time:${NC} ${RED}Measurement failed${NC}"
        echo ""
    fi
    
    # Overall assessment
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  Overall Assessment                                       ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
    
    local improvements=0
    local total_tests=0
    
    # Count improvements for successful tests only
    [ "${PHASE1_RESULTS[ping_avg]}" != "0" ] && [ "${PHASE2_RESULTS[ping_avg]}" != "0" ] && {
        total_tests=$((total_tests + 1))
        (( $(echo "$(calc_improvement "${PHASE1_RESULTS[ping_avg]}" "${PHASE2_RESULTS[ping_avg]}") > 0" | bc -l) )) && improvements=$((improvements + 1)) || true
    }
    
    [ "${PHASE1_RESULTS[ping_under_load]}" != "0" ] && [ "${PHASE2_RESULTS[ping_under_load]}" != "0" ] && {
        total_tests=$((total_tests + 1))
        (( $(echo "$(calc_improvement "${PHASE1_RESULTS[ping_under_load]}" "${PHASE2_RESULTS[ping_under_load]}") > 0" | bc -l) )) && improvements=$((improvements + 1)) || true
    }
    
    [ "${PHASE1_RESULTS[page_ttfb]}" != "0" ] && [ "${PHASE2_RESULTS[page_ttfb]}" != "0" ] && {
        total_tests=$((total_tests + 1))
        (( $(echo "$(calc_improvement "${PHASE1_RESULTS[page_ttfb]}" "${PHASE2_RESULTS[page_ttfb]}") > 0" | bc -l) )) && improvements=$((improvements + 1)) || true
    }
    
    [ "${PHASE1_RESULTS[page_load]}" != "0" ] && [ "${PHASE2_RESULTS[page_load]}" != "0" ] && {
        total_tests=$((total_tests + 1))
        (( $(echo "$(calc_improvement "${PHASE1_RESULTS[page_load]}" "${PHASE2_RESULTS[page_load]}") > 0" | bc -l) )) && improvements=$((improvements + 1)) || true
    }
    
    if [ $total_tests -eq 0 ]; then
        echo -e "${RED}✗ All tests failed - cannot determine improvement${NC}"
    elif [ $improvements -ge $((total_tests * 3 / 4)) ]; then
        echo -e "${GREEN}✓ Network optimizer shows significant improvements (${improvements}/${total_tests} metrics)${NC}"
    elif [ $improvements -ge $((total_tests / 2)) ]; then
        echo -e "${YELLOW}~ Network optimizer shows moderate improvements (${improvements}/${total_tests} metrics)${NC}"
    else
        echo -e "${RED}✗ Network optimizer shows minimal improvements (${improvements}/${total_tests} metrics)${NC}"
    fi
}

# ═══════════════════════════════════════════════════════════
# PHASE 1: WITHOUT NETOPT
# ═══════════════════════════════════════════════════════════

echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE} PHASE 1: WITHOUT NETWORK OPTIMIZER${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

# Backup current qdisc
ORIGINAL_QDISC=$(tc qdisc show dev "$INTERFACE" | head -1)
echo -e "${YELLOW}Current qdisc: ${ORIGINAL_QDISC}${NC}"
echo ""

# Run tests
measure_ping "1" || echo -e "${RED}Ping test failed${NC}"
echo ""
measure_latency_under_load "1" || echo -e "${RED}Latency under load test failed${NC}"
echo ""
measure_all_pages "1" || echo -e "${RED}Page load test failed${NC}"
echo ""

echo -e "${GREEN}✓ Phase 1 completed${NC}"
echo ""
echo -e "${YELLOW}Please install and apply netopt now:${NC}"
echo -e "  ${GREEN}sudo ./install.sh${NC}"
echo -e "  ${GREEN}sudo nmcli connection down <connection-name>${NC}"
echo -e "  ${GREEN}sudo nmcli connection up <connection-name>${NC}"
echo ""
read -p "Press Enter when netopt is active and network is reconnected..."
echo ""

# ═══════════════════════════════════════════════════════════
# PHASE 2: WITH NETOPT (Verify it's active)
# ═══════════════════════════════════════════════════════════

echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE} PHASE 2: WITH NETWORK OPTIMIZER${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""

# Verify netopt is installed
if [ ! -f "$NETOPT_SCRIPT" ]; then
    echo -e "${RED}Error: netopt script not found at $NETOPT_SCRIPT${NC}"
    echo -e "${YELLOW}Please install netopt first with: sudo ./install.sh${NC}"
    exit 1
fi

# Verify optimizations are applied
echo -e "${YELLOW}Verifying applied optimizations:${NC}"

# Check CAKE
if tc qdisc show dev "$INTERFACE" | grep -q "cake"; then
    echo -e "  ${GREEN}✓ CAKE qdisc: Active${NC}"
else
    echo -e "  ${RED}✗ CAKE qdisc: Not active${NC}"
    echo -e "    ${YELLOW}Tip: Reconnect the network or run: sudo nmcli con up <connection>${NC}"
fi

# Check routes
ROUTE_COUNT=$(ip route show default dev "$INTERFACE" | wc -l)
if [ "$ROUTE_COUNT" -ge 2 ]; then
    echo -e "  ${GREEN}✓ Routes: $ROUTE_COUNT (static + DHCP fallback)${NC}"
else
    echo -e "  ${YELLOW}⚠ Routes: $ROUTE_COUNT (expected 2)${NC}"
fi

# Check congestion control
CC=$(sysctl -n net.ipv4.tcp_congestion_control)
echo -e "  ${GREEN}✓ Congestion Control: $CC${NC}"

# Check tcp_slow_start_after_idle
SLOW_START=$(sysctl -n net.ipv4.tcp_slow_start_after_idle)
if [ "$SLOW_START" == "0" ]; then
    echo -e "  ${GREEN}✓ tcp_slow_start_after_idle: 0 (optimized)${NC}"
else
    echo -e "  ${YELLOW}⚠ tcp_slow_start_after_idle: $SLOW_START (not optimized)${NC}"
fi

# Check nftables QoS
if command -v nft >/dev/null 2>&1; then
    if nft list tables 2>/dev/null | grep -q "netopt"; then
        echo -e "  ${GREEN}✓ nftables QoS: Active${NC}"
    else
        echo -e "  ${YELLOW}⚠ nftables QoS: Not active${NC}"
    fi
else
    echo -e "  ${YELLOW}⚠ nftables: Not installed (QoS disabled)${NC}"
fi

echo ""
read -p "Press Enter to start Phase 2 tests..."
echo ""

sleep 2  # Brief stabilization

# Run tests
measure_ping "2" || echo -e "${RED}Ping test failed${NC}"
echo ""
measure_latency_under_load "2" || echo -e "${RED}Download test failed${NC}"
echo ""
measure_all_pages "2" || echo -e "${RED}Page load test failed${NC}"
echo ""

echo -e "${GREEN}✓ Phase 2 completed${NC}"
echo ""

# ═══════════════════════════════════════════════════════════
# RESULTS COMPARISON
# ═══════════════════════════════════════════════════════════

display_comparison

echo ""
echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Benchmark completed!                                     ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
