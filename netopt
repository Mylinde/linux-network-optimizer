#!/bin/bash
# =============================================================================================
# Linux Network Optimizer
# Automatic network performance optimization for Linux systems using NetworkManager dispatcher.
# Licensing: MIT
# Requires: bash, bc
# Copyright (c) 2026 Mario Herrmann. All rights reserved.
# =============================================================================================

# NetworkManager automatically passes these parameters:
INTERFACE="$1"
ACTION="$2"

# Only execute on relevant events
case "$ACTION" in
    up|dhcp4-change|dhcp6-change)
        ;;
    *)
        exit 0
        ;;
esac

# Determine CONNECTION from the passed interface
CONNECTION=$(nmcli -g GENERAL.CONNECTION device show "$INTERFACE" 2>/dev/null)

# Exit if no interface or connection
if [ -z "$INTERFACE" ] || [ -z "$CONNECTION" ]; then
    exit 0
fi

# Detect interface type via NetworkManager device type
INTERFACE_TYPE=$(LC_ALL=C nmcli -g GENERAL.TYPE device show "$INTERFACE" 2>/dev/null)

# Determine gateway and IP
GATEWAY=$(ip route show default dev "$INTERFACE" 2>/dev/null | awk '{print $3}' | head -n 1)
GATEWAY6=$(ip -6 route show default dev "$INTERFACE" 2>/dev/null | awk '{print $3}' | head -n 1)
IP=$(ip -4 addr show dev "$INTERFACE" 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n 1)

# Interface-specific TCP parameters
case "$INTERFACE_TYPE" in
    # High-speed wired connections - low latency/loss
    ethernet|bond|team|bridge|vlan|infiniband|ovs-bridge|ovs-interface|ovs-port)
        INITCWND=40
        INITRWND=60
        ;;
    # Wireless/Mobile connections - higher latency/loss
    wifi|gsm|cdma|bluetooth|wimax)
        INITCWND=30
        INITRWND=40
        ;;
    # VPN/Tunnels - variable conditions
    vpn|wireguard|ip-tunnel|tun|pppoe)
        INITCWND=20
        INITRWND=30
        ;;
    # Loopback - skip optimization
    loopback)
        exit 0
        ;;
    # Unknown/Other - RFC 6928 conservative default
    *)
        INITCWND=10
        INITRWND=10
        ;;
esac

# Activate CAKE QDisc
tc qdisc replace dev "$INTERFACE" root cake 2>/dev/null

# TCP optimizations (only set once, not on every event)
if [ "$ACTION" = "up" ]; then
    sysctl -q -w net.ipv4.tcp_slow_start_after_idle=0
    sysctl -q -w net.ipv4.tcp_congestion_control=bbr 
    sysctl -q -w net.ipv4.tcp_notsent_lowat=131072
    sysctl -q -w net.ipv4.tcp_fin_timeout=3
    sysctl -q -w net.ipv4.tcp_tw_reuse=1
    sysctl -q -w net.core.default_qdisc=cake

    # RAM-based TCP buffer calculation
    TOTAL_RAM_BYTES=$(free -b | awk '/^Mem:/{print $2}')
    FACTOR="0.002"
    
    # Calculate maximum value (requires bc for floating point math)
    # Ensures minimum of 4MB and maximum of 128MB
    RMEM_MAX=$(echo "$TOTAL_RAM_BYTES * $FACTOR" | bc -l | cut -d. -f1)
    
    # Sanity checks (set limits)
    [ "$RMEM_MAX" -lt 4194304 ] && RMEM_MAX=4194304   # Lower limit 4MB
    [ "$RMEM_MAX" -gt 134217728 ] && RMEM_MAX=134217728 # Upper limit 128MB
    
    # Apply calculated values
    sysctl -q -w net.core.rmem_max="$RMEM_MAX"
    sysctl -q -w net.core.wmem_max="$RMEM_MAX"
    sysctl -q -w net.ipv4.tcp_rmem="4096 87380 $RMEM_MAX"
    sysctl -q -w net.ipv4.tcp_wmem="4096 65536 $RMEM_MAX"
fi

# Optimize IPv4 route
if [ -n "$GATEWAY" ] && [ "$GATEWAY" != "--" ] && [ -n "$IP" ]; then
    # NetworkManager settings (only on first "up" event)
    if [ "$ACTION" = "up" ]; then
        nmcli con mod "$CONNECTION" ipv4.may-fail no 2>/dev/null
    fi
    
    # Remove DHCP routes
    ip route del default via "$GATEWAY" dev "$INTERFACE" proto dhcp 2>/dev/null
    
    # Only add static route if it doesn't exist yet
    if ! ip route show | grep -q "default via $GATEWAY dev $INTERFACE proto static.*initcwnd $INITCWND"; then
        ip route add default via "$GATEWAY" dev "$INTERFACE" proto static src "$IP" metric 500 initcwnd $INITCWND initrwnd $INITRWND
    fi
fi

# Optimize IPv6 route
if [ -n "$GATEWAY6" ] && [ "$GATEWAY6" != "--" ]; then
    if [ "$ACTION" = "up" ]; then
        nmcli con mod "$CONNECTION" ipv6.may-fail no 2>/dev/null
    fi
    
    # Remove router advertisement routes
    ip -6 route del default via "$GATEWAY6" dev "$INTERFACE" proto ra 2>/dev/null
    
    # Only add static IPv6 route if not present
    if ! ip -6 route show | grep -q "default via $GATEWAY6 dev $INTERFACE proto static.*initcwnd $INITCWND"; then
        ip -6 route add default via "$GATEWAY6" dev "$INTERFACE" proto static metric 500 initcwnd $INITCWND initrwnd $INITRWND pref high
    fi
fi

exit 0
