#!/bin/bash

# Network Optimize Script

# Function to calculate intelligent tcp_fin_timeout based on RTT
calculate_fin_timeout() {
    local INTERFACE=$1
    local GATEWAY=$2
    local RTT

    # Measure RTT to gateway
    RTT=$(ping -c 4 $GATEWAY | awk -F '/' 'END {print $5}')

    # Determine tcp_fin_timeout based on interface type
    case $(cat /sys/class/net/$INTERFACE/type) in
        "ether"|"bond"|"team"|"bridge"|"vlan"|"infiniband")
            TCP_FIN_TIMEOUT=5
            ;;  
        "wifi"|"bluetooth")
            TCP_FIN_TIMEOUT=10
            ;;  
        "gsm"|"cdma"|"wimax")
            TCP_FIN_TIMEOUT=20
            ;;  
        "tun"|"tap"|"pppoe"|"vpn"|"wireguard"|"ip-tunnel")
            if [[ -n "$RTT" ]]; then
                TCP_FIN_TIMEOUT=$(echo "3 * $RTT + 5" | bc)
                if (( $(echo "$TCP_FIN_TIMEOUT > 30" | bc -l) )); then
                    TCP_FIN_TIMEOUT=30
                fi
            else
                TCP_FIN_TIMEOUT=15
            fi
            ;;  
        *)
            TCP_FIN_TIMEOUT=15
            ;;  
    esac

    echo $TCP_FIN_TIMEOUT
}

# Extract IPv6 address
INTERFACE=$1
IP6=$(ip -6 addr show dev "$INTERFACE" scope global 2>/dev/null | grep -oP '(?<=inet6\s)[0-9a-f:]+' | head -n 1)

# Validate IPv6 gateway
if [[ -n "$2" ]]; then
    GATEWAY=$2
    if [[ "$GATEWAY" =~ ^2000:.* ]] || [[ "$GATEWAY" =~ ^fe80:.* ]]; then
        echo "Valid IPv6 gateway"
    else
        echo "Invalid IPv6 gateway" >&2
        exit 1
    fi
else
    echo "No IPv6 gateway provided" >&2
    exit 1
fi

# Check for global IPv6 address and handle gateway accordingly
if [[ -n "$IP6" ]]; then
    # Add the global IPv6 route
    ip -6 route add $GATEWAY dev "$INTERFACE" src "$IP6"
else
    # No global IPv6 address, handle link-local address
    if [[ "$GATEWAY" == fe80::* ]]; then
        ip -6 route add $GATEWAY dev "$INTERFACE"
    else
        echo "Warning: Gateway exists but no global IPv6 address found" >&2
    fi
fi

# Calculate tcp_fin_timeout
TCP_FIN_TIMEOUT=$(calculate_fin_timeout "$INTERFACE" "$GATEWAY")

# Apply the tcp_fin_timeout using sysctl
sysctl -w net.ipv4.tcp_fin_timeout=$TCP_FIN_TIMEOUT
